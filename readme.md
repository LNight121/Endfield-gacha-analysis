# 摘要
总所周知，明日方舟终末地的卡池机制十分的复杂，网上有很多基于蒙特卡洛法的对卡池的概率分析。也有很多经验结论，如：在上个池子已经投入了 45 发时应该补充到 60 发以追求下一个卡池的额外赠送十连；在上一个池子的小保底水位达到 64 发后不应该抽卡，哪怕是赠送的免费抽也不能抽。

不过这些基于经验的定向分析略显粗糙。因此本程序给出了一个基于卡池概率解析解的定量分析，输入你当前在卡池投入的抽数（大于 60 视作 60），当前的大小保底水位，下个池子的目标UP数量，当前的赠送抽数还剩多少。程序即可计算你此时是否应该抽卡。抽卡前后的期望花费分别是多少。

关键词：dp、动态规划、概率论

# 正文
由于这不是论文，我实在是编不下去了，直接讲怎么用。

注意这个程序是算的下一个卡池的，即你的目标角色是下一个角色。如果你的目标角色就是当期UP角色只需要抽卡就行了，而如果你的目标角色就是下期UP角色要考虑的就多了。

运行程序后依次输入：
- 你当前在卡池投入的抽数（大于 60 填入 60）
- 当前的大保底水位
- 当前的保底水位
- 下个池子的目标UP数量
- 当前的赠送抽数还剩多少

程序即可计算你此时是否应该抽卡，抽卡前后的期望花费分别是多少。注意计算的期望花费不含任何免费的抽数。

# 第 1 章 原理
考虑到代码没有任何注释，我还是讲一下原理吧。

我们现算目标卡池的期望抽数。

记 $dp_{i,j,k}$ 表示当前的大保底计数为 $i$ ，小保底计数为 $j$ ，已经抽出的UP数量为 $k$ 。显然当已经抽出的UP数量等于目标数量时，已经不需要抽卡了，因此 $dp_{i,j,K}=0$ 此处用 $K$ 表示目标的UP数量。

然后考虑转移，如果当前的大保底计数为 $i$ ，小保底计数为 $j$ ，记此时出UP的概率为 $x$ ，出六星但是歪的概率为 $y$ ,没出的概率为 $z$ ，那么 $dp_{i,j,k}=x\times dp_{0,0,k+1}+y\times dp_{i+1,0,k}+z\times dp_{i+1,j+1,k}+1$ ，其中最后的+1是这次抽卡本身的花费。

当然，上面的式子没考虑30抽时的加急十连，不过这个只需要简单处理就行了。因此，只要按照上面的顺序遍历一遍即可计算出期望……吗？

上面的式子只适用于你只要一个目标UP的情况的，放出来只是便于读者理解正真的算法。

记 $dp_{h,i,j,k}$ 表示当前抽了 $h$ 发,当前的大保底计数为 $i$ ，小保底计数为 $j$ ，已经抽出的UP数量为 $k$ 。同样的，有 $dp_{h,i,j,K}=0$ 。

然后考虑转移，有 $dp_{h,i,j,k}=x\times dp_{h+1,0,0,k+1}+y\times dp_{h+1,0,i+1,0,k}+z\times dp_{h+1,i+1,j+1,k}+1$ 。

我们按照 $h$ 从大到小，其他三个维度任意的顺序遍历一遍dp数组，才能得到答案。并在 $h%240==0$ 时特殊处理，在 $h$ 小于5时不做额外的+1操作， 由于 $h\leq K\times 120$ ，所以总时间复杂度为 $O(K^2\times 120^2 \times 80)$ 。

上面只是第一步，我们预处理出这些信息是为了方便计算在上一个卡池时的决策。

记 $a_{h,i,j,k}$ 表示当前抽了 $h$ 发,当前的大保底计数为 $i$ ，小保底计数为 $j$ ，剩余免费抽数为 $k$ 时的期望。显然我们有决策不抽，此时 $a_{h,i,j,k}=dp_{0,0,j,0}$ 。注意在 $h=60$ 时从另一个在 $h$ 小于15时就不做额外的+1操作的dp数组转移。

然后我们可以写出转移方程，记得和默认值取min：
- 当 $k!=0$ 时， $a_{h,i,j,k}=x\times a_{h+1,0,0,k-1}+y\times a_{h+1,0,i+1,0,k-1}+z\times a_{h+1,i+1,j+1,k-1}$ 。
- 当 $k==0$ 时， $a_{h,i,j,k}=x\times a_{h+1,0,0,k-1}+y\times a_{h+1,0,i+1,0,k-1}+z\times a_{h+1,i+1,j+1,k-1} + 1$ 。

值得注意的是，由于 $dp$ 数组关于第三位（即小保底维度）的偏导始终小于1，因此在旧卡池抽满60发后一定不需要**付费**抽卡，因此 $a_{60,i,j,0}$ 不需要转移，直接取默认值即可。
